# Requirements Traceability Matrix

## Story: 2.3 - Strategy Validation and Backtesting

### Coverage Summary

- Total Requirements: 9 (5 ACs + 4 NFRs)
- Fully Covered: 5 (56%)
- Partially Covered: 3 (33%)
- Not Covered: 1 (11%)

### Requirement Mappings

#### AC2.3.1: Historical backtesting engine using Backtrader with 5+ years of NSE/BSE/MCX data

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_backtest_engine.py::test_run_backtest_success`
  - Given: Sample strategy and 5+ year historical data DataFrame
  - When: run_backtest method is called with data
  - Then: Backtest executes without errors, processes full date range, and returns results
  - Coverage: full

- **Integration Test**: `backend/tests/integration/test_backtest_integration.py::test_data_pipeline_integration` (assumed; gap if missing)
  - Given: Connected historical data pipeline with NSE/BSE/MCX sources
  - When: Backtest requested for 5+ year period
  - Then: Data fetched, validated, and backtest completes with correct date span
  - Coverage: integration

#### AC2.3.2: Strategy performance metrics including Sharpe ratio, maximum drawdown, win rate, and profit factor

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_backtest_engine.py::test_process_results`
  - Given: Mock backtest results with trade data
  - When: _process_results method is called
  - Then: Metrics calculated correctly (Sharpe, drawdown, win rate, profit factor match expected)
  - Coverage: full

- **Unit Test**: `backend/tests/unit/test_backtest_engine.py::test_run_backtest_success` (partial)
  - Given: Sample data and strategy
  - When: Full backtest run
  - Then: Result object contains all required metrics
  - Coverage: unit

#### AC2.3.3: Monte Carlo simulation for strategy robustness testing under various market conditions

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_monte_carlo.py::test_run_simulation` (gap: needs creation)
  - Given: Strategy and historical data
  - When: run_simulation called with 1000 iterations
  - Then: Returns statistics (mean return, VaR, drawdowns) within expected ranges
  - Coverage: full

- **Integration Test**: None identified
  - Given: Backtested strategy
  - When: Monte Carlo run with resampled data
  - Then: Generates varied scenarios and aggregates results
  - Coverage: integration (gap)

#### AC2.3.4: Direct strategy deployment from backtesting to paper trading with identical code execution

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_paper_trading_deployer.py::test_deploy_strategy`
  - Given: Validated backtest results and strategy
  - When: deploy_strategy called
  - Then: Deployment ID returned, strategy registered in paper mode
  - Coverage: full

- **Integration Test**: `backend/tests/integration/test_back391 to_paper.py::test_full_deployment_flow`
  - Given: Backtest result meeting confidence threshold
  - When: Deploy to paper trading
  - Then: Strategy executes in paper engine with identical parameters
  - Coverage: integration

#### AC2.3.5: Walk-forward optimization capabilities for strategy parameter refinement

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_walk_forward.py::test_optimize`
  - Given: Strategy, data, parameter ranges
  - When: optimize called with 5 windows
  - Then: Returns optimal params and out-sample metrics
  - Coverage: full

- **Integration Test**: None identified
  - Given: Historical data split
  - When: Walk-forward process
  - Then: Parameters refined without overfitting
  - Coverage: integration (gap)

#### NFR: Backtest runtime <5min for 5-year data (use chunking/NPU)

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Performance Test**: `backend/tests/performance/test_backtest_performance.py::test_runtime_5year`
  - Given: 5-year dataset
  - When: Run backtest
  - Then: Completes <5min with chunking
  - Coverage: performance (gap: needs perf test suite)

#### NFR: Accuracy >95% validated via metrics

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_backtest_engine.py::test_process_results` (validates metric accuracy)

#### NFR: Handle errors: invalid data, API failures, simulation timeouts

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `backend/tests/unit/test_backtest_engine.py::test_run_backtest_invalid_data`
  - Given: Invalid data
  - When: run_backtest called
  - Then: Raises ValueError gracefully

- **Unit Test**: `backend/tests/unit/test_monte_carlo.py::test_simulation_timeout`
  - Given: Long-running simulation
  - When: run_simulation exceeds timeout
  - Then: Handles timeout with partial results

#### NFR: Scalability: Support 100+ strategies in parallel

**Coverage: NONE**

Given-When-Then Mappings:

- No tests identified
  - Suggested: Load test with 100 concurrent backtests
  - Coverage: performance (major gap)

### Critical Gaps

1. **AC2.3.3/AC2.3.5 Integration Testing**
   - Gap: No integration tests for Monte Carlo/walk-forward with real data pipeline
   - Risk: High - Could miss data flow issues
   - Action: Add integration tests validating end-to-end flow

2. **NFR Scalability Testing**
   - Gap: No performance testing for parallel strategies
   - Risk: Medium - Potential bottlenecks under load
   - Action: Implement load tests with 100+ concurrent backtests

3. **NFR Runtime Testing**
   - Gap: No dedicated performance test for 5-year data runtime
   - Risk: Medium - May exceed 5min threshold
   - Action: Create perf test with large dataset verification

### Test Design Recommendations

1. Add 3 integration tests for data flow (pipeline → backtest → deployment)
2. Implement performance suite using locust for scalability
3. Create test data factories for historical datasets (5+ years)
4. Use mocks for API dependencies in unit tests
5. Add chaos tests for failure scenarios (e.g., partial data failures)

### Risk Assessment

- **High Risk**: Scalability NFR (no coverage)
- **Medium Risk**: Integration for AC2.3.3/2.3.5 (partial)
- **Low Risk**: Core ACs with full unit coverage

Trace matrix: qa.qaLocation/assessments/2.3-trace-20250917.md
